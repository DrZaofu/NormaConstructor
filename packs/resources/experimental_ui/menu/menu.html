<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <script src="../UIEngine.js"></script>
    <link rel="stylesheet" href="../styles.css" />
</head>

<body>
    <div class="body1">
        <div style='width: 90%;height:auto;display:flex;flex-direction: row;'>
            <div class="minecraft-container" id="ServerSideOptionPanel"
                style='right:12px;width: 20%;display:flex;flex-direction: column;'>
                <div class="minecraft-container-dark">
                    <div>
                        <div style="display: flex;flex-direction: column;justify-content:center;">
                            <div>
                                <div style="width: 100%;">Request Additional Position</div>
                                <div style="display: flex;flex-direction: row;justify-content:center;">
                                    <button class="button" style="width: 50%;padding: 0%;"
                                        onclick="setServerSideOption('__requestAdditionalPosition',true)">On</button>
                                    <button class="button" style="width: 50%;padding: 0%;"
                                        onclick="setServerSideOption('__requestAdditionalPosition',false)">Off</button>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex;flex-direction: column;justify-content:center;">
                            <div>
                                <div style="width: 100%;">Request Additional BlockType</div>
                                <div style="display: flex;flex-direction: row;justify-content:center;">
                                    <button class="button" style="width: 50%;padding: 0%;"
                                        onclick="setServerSideOption('__requestAdditionalBlockType',true)">On</button>
                                    <button class="button" style="width: 50%;padding: 0%;"
                                        onclick="setServerSideOption('__requestAdditionalBlockType',false)">Off</button>
                                </div>

                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="display: flex;flex-direction: column;justify-content:center;">
                            <div>
                                <div style="width: 100%;">Request Additional Direction</div>
                                <div style="display: flex;flex-direction: row;justify-content:center;">
                                    <button class="button" style="width: 50%;padding: 0%;"
                                        onclick="setServerSideOption('__requestAdditionalDirection',true)">On</button>
                                    <button class="button" style="width: 50%;padding: 0%;"
                                        onclick="setServerSideOption('__requestAdditionalDirection',false)">Off</button>
                                </div>

                            </div>
                        </div>
                    </div> 
                </div>
            </div>
            <div class="minecraft-container" style='width: 60%;display:flex;flex-direction: column;'>
                <div>
                    <div style="text-align:center;">Constructor panel</div>
                    <button id="close" onclick="closeUI()" class="close-button"
                        style="width: 30px;height:30px;text-align: center;padding: 0 0 0 0;">X</button>
                </div>

                <div class="minecraft-container-dark">
                    <div style="display: flex;flex-direction: row;">
                        <button class="button" style="width: 10%;" onclick="chooseLastGenerator()">←</button>
                        <button class="button" style="width: 80%;" id="generatorName">NZ IS JULAO</button>
                        <button class="button" style="width: 10%;" onclick="chooseNextGenerator()">→</button>
                    </div>
                    <div id="mainMenu">
                        <div id="testText">So HUGE NZ is!</div>
                        <div style="display: flex;flex-direction: row;">
                            <div style="width: 90%;">How huge NZ is:</div>
                            <input id="testEdittext" type="text" style="width: 10%;text-align: center;" value="INF"
                                onclick="document.getElementById( 'testEdittext' ).value = 'aaa' ">
                        </div>
                        <div style="display: flex;flex-direction: row;">
                            <div style="width: 90%;">Is NZ the one and only JULAO?</div>
                            <button id="testCheckbox" class="button" style="width: 10%;padding: 0%;"
                                onclick="alterChoice()">True</button>
                        </div>
                        <div style="display: flex;flex-direction: row;">
                            <div style="width: 90%;">Let's all shout:NZ IS JULAO!</div>
                            <button id="testButton" class="button" style="width: 10%;padding: 0%;"
                                onclick="alterChoice()">Shout!</button>
                        </div>
                    </div>

                </div>
            </div>
            <div class="minecraft-container" id="NumPad"
                style='left:12px;width: 20%; display:flex;flex-direction: column;'>
                <div class="minecraft-container-dark">
                    <div>
                        <div id="inputDisplay">19260817</div>
                        <div style="display:flex;flex-direction: row;align-items: stretch;">
                            <div style="width: 80%;">
                                <div style="display: flex;flex-direction: row;justify-content:center;">
                                    <button class="button" style="width: 33%;padding: 0%;"
                                        onclick="handleEditTextInput('7')">7</button>
                                    <button class="button" style="width: 33%;padding: 0%;"
                                        onclick="handleEditTextInput('8')">8</button>
                                    <button class="button" style="width: 33%;padding: 0%;"
                                        onclick="handleEditTextInput('9')">9</button>
                                </div>
                                <div style="display: flex;flex-direction: row;justify-content:center;">
                                    <button class="button" style="width: 33%;padding: 0%;"
                                        onclick="handleEditTextInput('4')">4</button>
                                    <button class="button" style="width: 33%;padding: 0%;"
                                        onclick="handleEditTextInput('5')">5</button>
                                    <button class="button" style="width: 33%;padding: 0%;"
                                        onclick="handleEditTextInput('6')">6</button>
                                </div>
                                <div style="display: flex;flex-direction: row;justify-content:center;">
                                    <button class="button" style="width: 33%;padding: 0%;"
                                        onclick="handleEditTextInput('1')">1</button>
                                    <button class="button" style="width: 33%;padding: 0%;"
                                        onclick="handleEditTextInput('2')">2</button>
                                    <button class="button" style="width: 33%;padding: 0%;"
                                        onclick="handleEditTextInput('3')">3</button>
                                </div>
                                <div style="display: flex;flex-direction: row;justify-content:center;">
                                    <button class="button" style="width: 33%;padding: 0%;"
                                        onclick="handleEditTextInput('-')">-</button>
                                    <button class="button" style="width: 33%;padding: 0%;"
                                        onclick="handleEditTextInput('0')">0</button>
                                    <button class="button" style="width: 33%;padding: 0%;"
                                        onclick="handleEditTextInput('·')">.</button>
                                </div>
                                <div></div>
                            </div>
                            <div
                                style="padding-left: 6px;padding-right: 0px;width:20%;height:auto;display: flex;flex-direction: column;">
                                <button class="button" style="width: 100%;padding: 0%;height: 30%;"
                                    onclick="handleEditTextInput('d')">Del</button>
                                <button class="button" style="width: 100%;padding: 0%;height: 30%;"
                                    onclick="setNumber()">Ent</button>
                            </div>
                        </div>

                    </div>

                </div>
            </div>
        </div>
</body>
<script type="text/javascript">


    let scriptEngineHandle = null;
    engine.on("facet:updated:core.scripting", (scriptEngine) => scriptEngineHandle = scriptEngine);
    engine.trigger("facet:request", ["core.scripting"]);

    let generatorName = document.getElementById("generatorName")
    let mainMenu = document.getElementById("mainMenu")
    let inputDisplay = document.getElementById("inputDisplay")
    let idOfEditTextOnFocus

    let name = ""
    let positionUsage
    let blockTypeUsage
    let directionUsage
    let optionUsage
    let editTextInput = ""

    let currentChoices = {}

    function eventDataWrapper(data) {
        return "NormaConstructor:" + JSON.stringify(data, null, '    ')
    }
    function displayChat(message) {
        scriptEngineHandle.triggerEvent(eventDataWrapper({ type: "displayChat", data: message }))
    }

    function sendCommand(command) {
        scriptEngineHandle.triggerEvent(eventDataWrapper({ type: "command", data: command }))
    }
    function getData(request) {
        scriptEngineHandle.triggerEvent(eventDataWrapper({ type: "get", data: request }))
    }
    function setData(key, value) {
        scriptEngineHandle.triggerEvent(eventDataWrapper({ type: "set", data: { key: key, value: value } }))
    }
    function setServerSideOption(key, value) {
        scriptEngineHandle.triggerEvent(eventDataWrapper({ type: "setServerSideOption", data: { key: key, value: value } }))
    }

    function chooseNextGenerator() {
        sendCommand("chooseNextGenerator")
        sendCommand("reload")
    }
    function chooseLastGenerator() {
        sendCommand("chooseLastGenerator")
        sendCommand("reload")
    }
    function closeUI() {
        sendCommand("closeMenu")
    }
    function openNumPad() {
        document.getElementById("NumPad").style.visibility = "visible"
    }
    function closeNumPad() {
        document.getElementById("NumPad").style.visibility = "hidden"
    }
    function alterChoice(id) {
        //TODO:
        //I suppose I should alter the value stored in this menu.
        //Though it seems it doesn't matter.

        currentChoices[id] = (currentChoices[id] + 1) % optionUsage[id].data.length
        let element = document.getElementById(id)
        element.textContent = optionUsage[id].data[currentChoices[id]].text
        setData(
            optionUsage[id].key,
            optionUsage[id].data[currentChoices[id]].value
        )
    }
    function handleEditTextInput(character) {
        if (character == 'd')
            if (editTextInput.length > 0) editTextInput = editTextInput.slice(0, editTextInput.length - 1)
            else;
        else editTextInput += character
        inputDisplay.textContent = editTextInput
    }
    function setNumber() {
        let number = Number.parseFloat(editTextInput)
        let element = document.getElementById(idOfEditTextOnFocus)
        // option[optionUsage[idOfEditTextOnFocus].key]=
        element.value = number
        setData(
            optionUsage[idOfEditTextOnFocus].key,
            number
        )
        editTextInput = ''
        inputDisplay.textContent = ''
    }

    sendCommand("reload")

    engine.on("NormaConstructor:reload", (eventData) => {
        displayChat(eventData)

        let data = JSON.parse(eventData)

        name = data["description"].name
        let usage = data["description"].usage
        positionUsage = usage.positionUsage
        blockTypeUsage = usage.blockTypeUsage
        directionUsage = usage.directionUsage
        optionUsage = usage.optionUsage
        let option = data["option"]

        generatorName.textContent = name
        inputDisplay.textContent = ''

        while (mainMenu.firstChild) mainMenu.removeChild(mainMenu.firstChild);

        for (let i in optionUsage) {

            switch (optionUsage[i].viewtype) {
                case "text": {
                    mainMenu.insertAdjacentHTML('beforeend', `<div id=${i}>${optionUsage[i].text}</div>`)
                    break;
                }
                case "edittext": {
                    let defaultNumber = option[optionUsage[i].key]
                    if (defaultNumber == undefined) defaultNumber = optionUsage[i].default

                    mainMenu.insertAdjacentHTML('beforeend',
                        `<div style="display: flex;flex-direction: row;">
                            <div style="width: 90%;">${optionUsage[i].text}</div>
                            <input id=${i} type="text" style="width: 10%;text-align: center;" value=${defaultNumber}
                                onclick="idOfEditTextOnFocus = ${i};inputDisplay.textContent = editTextInput = '0';">
                        </div>`)
                    break;
                }
                case "checkbox": {
                    let defaultChoice = optionUsage[i].data.findIndex(element => element.value == (option[optionUsage[i].key]))
                    if (defaultChoice == -1) defaultChoice = 0
                    currentChoices[i] = defaultChoice
                    let defaultText = optionUsage[i].data[defaultChoice].text

                    mainMenu.insertAdjacentHTML('beforeend', `
                    <div style="display: flex;flex-direction: row;">
                            <div style="width: 90%;">${optionUsage[i].text}</div>
                            <button id=${i} class="button" style="width: 10%;padding: 0%;"
                                onclick="alterChoice(${i})">${defaultText}</button>
                            </div>`
                    )
                    break;
                }
                case "button": {
                    let defaultChoice = optionUsage[i].data.findIndex(element => element.value == (option[optionUsage[i].key]))
                    if (defaultChoice == -1) defaultChoice = 0
                    currentChoices[i] = defaultChoice
                    let defaultText = optionUsage[i].data[defaultChoice].text

                    mainMenu.insertAdjacentHTML('beforeend', `
                    <div style="display: flex;flex-direction: row;">
                            <div style="width: 90%;">${optionUsage[i].text}</div>
                            <button id=${i} class="button" style="width: 10%;padding: 0%;"
                                onclick="alterChoice(${i})">${defaultText}</button>
                            </div>`
                    )
                    break;
                }
            }
        }

    })
</script>

</html>